= render "projects/issues/head"
%h3.page-title
  #{t('milestone', scope: 'projects.issues.issues').titleize} ##{@milestone.iid}
  %small
    = @milestone.expires_at
  .pull-right
    - if can?(current_user, :admin_milestone, @project)
      = link_to edit_project_milestone_path(@project, @milestone), class: "btn btn-grouped" do
        %i.icon-edit
        = t('general.edit')
      - if @milestone.active?
        = link_to t('close_milestone', scope: 'projects.milestones.milestone'), project_milestone_path(@project, @milestone, milestone: {state_event: :close }), method: :put, class: "btn btn-remove btn-grouped"
      - else
        = link_to t('.reopen_milestone'), project_milestone_path(@project, @milestone, milestone: {state_event: :activate }), method: :put, class: "btn btn-grouped"

- if @milestone.issues.any? && @milestone.can_be_closed?
  .alert.alert-success
    %span= t('.all_issues_for_this_milestone_are_closed')

.back-link
  = link_to project_milestones_path(@project) do
    = raw t('.to_milestones_list')


.issue-box{ class: issue_box_class(@milestone) }
  .state
    %span.state-label
      - if @milestone.closed?
        = t('general.closed')
      - elsif @milestone.expired?
        = t('general.expired')
      - else
        = t('general.open')

  %h4.title
    = gfm escape_once(@milestone.title)

  .context
    %p
      #{t('.progress')}:
      #{@milestone.closed_items_count} #{t('general.closed').downcase}
      &ndash;
      #{@milestone.open_items_count} #{t('general.open').downcase}
      %span.pull-right= @milestone.expires_at
    .progress.progress-info
      .progress-bar{style: "width: #{@milestone.percent_complete}%;"}

  - if @milestone.description.present?
    .description
      .wiki
        = preserve do
          = markdown @milestone.description

%ul.nav.nav-tabs
  %li.active
    = link_to '#tab-issues', 'data-toggle' => 'tab' do
      = t('general.issues')
      %span.badge= @issues.count
  %li
    = link_to '#tab-merge-requests', 'data-toggle' => 'tab' do
      = t('general.merge_requests')
      %span.badge= @merge_requests.count
  %li
    = link_to '#tab-participants', 'data-toggle' => 'tab' do
      = t('general.participants')
      %span.badge= @users.count

  .pull-right
    = link_to new_project_issue_path(@project, issue: { milestone_id: @milestone.id }), class: "btn btn-small btn-grouped", title: t('new_issue', scope: 'projects.issues.head') do
      %i.icon-plus
      = t('new_issue', scope: 'projects.issues.head')
    = link_to t('browse_issues', scope: 'projects.issues.head'), project_issues_path(@milestone.project, milestone_id: @milestone.id), class: "btn btn-small edit-milestone-link btn-grouped"

.tab-content
  .tab-pane.active#tab-issues
    .row
      .col-md-4
        = render('issues', title: t('.unstarted_issues'), issues: @issues.opened.unassigned)
      .col-md-4
        = render('issues', title: t('.ongoing_issues'), issues: @issues.opened.assigned)
      .col-md-4
        = render('issues', title: t('.completed_issues'), issues: @issues.closed)

  .tab-pane#tab-merge-requests
    .row
      .col-md-6
        .ui-box
          .title= t('general.open')
          %ul.well-list
            - @merge_requests.opened.each do |merge_request|
              = render 'merge_request', merge_request: merge_request
      .col-md-6
        .ui-box
          .title= t('general.closed')
          %ul.well-list
            - @merge_requests.closed.each do |merge_request|
              = render 'merge_request', merge_request: merge_request

  .tab-pane#tab-participants
    %ul.bordered-list
      - @users.each do |user|
        %li
          = link_to user, title: user.name, class: "dark" do
            = image_tag avatar_icon(user.email, 32), class: "avatar s32"
            %strong= truncate(user.name, lenght: 40)
            %br
            %small.cgray= user.username
